name: CI-CD (dev → staging)

on:
  push:
    branches: [ main ]
    # Optional: run only when these change
    # paths: [ 'hello.sh', '.github/workflows/**' ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

concurrency:
  group: cicd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 1) TEST across small matrix
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      - name: Show runner info
        run: uname -a || ver
        shell: bash
      - name: Run hello.sh (fails if script has errors)
        shell: bash
        run: bash -eo pipefail ./hello.sh

  # 2) PACKAGE and upload artifact
  package:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build artifact (dummy)
        shell: bash
        run: |
          set -e
          echo "build from ${GITHUB_SHA} at $(date -u)" > build.txt
          echo "artifact created: build.txt"
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app
          path: build.txt

  # 3) DEPLOY to DEV (auto)
  deploy_dev:
    needs: package
    runs-on: ubuntu-latest
    environment:
      name: dev
    steps:
      - uses: actions/checkout@v4            # <-- ensures hello.sh is present
      - uses: actions/download-artifact@v4   # <-- brings build.txt
        with:
          name: app
          path: .
      - name: Show artifact & run script in DEV
        shell: bash
        run: |
          set -e
          echo "=== DEV DEPLOY ==="
          cat build.txt || true
          bash -eo pipefail ./hello.sh
          echo "Deployed to DEV"

  # 4) DEPLOY to STAGING (requires approval)
  deploy_staging:
    needs: deploy_dev
    runs-on: ubuntu-latest
    environment:
      name: staging   # set Required reviewers in Settings → Environments → staging
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: app
          path: .
      - name: Show artifact & run script in STAGING
        shell: bash
        run: |
          set -e
          echo "=== STAGING DEPLOY ==="
          cat build.txt || true
          bash -eo pipefail ./hello.sh
          echo "Deployed to STAGING"
